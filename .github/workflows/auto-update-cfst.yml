name: è‡ªåŠ¨æ›´æ–°CloudflareSpeedTestå·¥å…·åŒ…

# è§¦å‘æ—¶æœºï¼šæ¯å¤©è‡ªåŠ¨è¿è¡Œ + æ‰‹åŠ¨è§¦å‘
on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤© UTC 0 ç‚¹æ‰§è¡Œ
  workflow_dispatch:     # å…è®¸æ‰‹åŠ¨è§¦å‘è°ƒè¯•

jobs:
  update-and-organize:
    runs-on: ubuntu-latest
    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»“åº“ä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true  # ä¿ç•™æƒé™ç”¨äºæäº¤

      # æ­¥éª¤2ï¼šè·å–æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯å’Œä¸‹è½½é“¾æ¥
      - name: Get latest release info
        id: get_latest
        run: |
          # è°ƒç”¨ GitHub API è·å–æœ€æ–° Release æ•°æ®
          RELEASE_DATA=$(curl -s "https://api.github.com/repos/XIU2/CloudflareSpeedTest/releases/latest")
          LATEST_VERSION=$(echo "$RELEASE_DATA" | jq -r '.tag_name')
          # æå– Linux amd64 å‹ç¼©åŒ…ä¸‹è½½é“¾æ¥ï¼ˆåŒ¹é…ç›®æ ‡æ–‡ä»¶ï¼‰
          DOWNLOAD_URL=$(echo "$RELEASE_DATA" | jq -r '.assets[] | select(.name == "cfst_linux_amd64.tar.gz") | .browser_download_url')
          
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "download_url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT
          echo "âœ… æœ€æ–°ç‰ˆæœ¬ï¼š$LATEST_VERSIONï¼Œä¸‹è½½é“¾æ¥ï¼š$DOWNLOAD_URL"

      # æ­¥éª¤3ï¼šæ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°ï¼ˆå¯¹æ¯”æœ¬åœ°ç‰ˆæœ¬è®°å½•ï¼‰
      - name: Check update necessity
        id: check_update
        run: |
          CURRENT_VERSION=$(cat cfst_linux_amd64/VERSION 2>/dev/null || echo "none")  # ç‰ˆæœ¬è®°å½•å­˜æ”¾åœ¨ç›®æ ‡ç›®å½•
          echo "æœ¬åœ°å½“å‰ç‰ˆæœ¬ï¼š$CURRENT_VERSION"
          echo "è¿œç¨‹æœ€æ–°ç‰ˆæœ¬ï¼š${{ steps.get_latest.outputs.latest_version }}"
          
          if [ "$CURRENT_VERSION" != "${{ steps.get_latest.outputs.latest_version }}" ]; then
            echo "update_needed=true" >> $GITHUB_OUTPUT
          else
            echo "å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æ›´æ–°"
            echo "update_needed=false" >> $GITHUB_OUTPUT
          fi

      # æ­¥éª¤4ï¼šä¸‹è½½å‹ç¼©åŒ…å¹¶å¤„ç†ï¼ˆä»…å½“éœ€è¦æ›´æ–°æ—¶æ‰§è¡Œï¼‰
      - name: Download and process latest release
        if: steps.check_update.outputs.update_needed == 'true'
        run: |
          # ä¸‹è½½å‹ç¼©åŒ…ï¼ˆæŒ‡å®šæ–‡ä»¶åé¿å…å†²çªï¼‰
          echo "ğŸ“¥ ä¸‹è½½æœ€æ–°å‹ç¼©åŒ…..."
          wget -q -O cfst_temp.tar.gz ${{ steps.get_latest.outputs.download_url }}
          
          # æ ¡éªŒæ–‡ä»¶ç±»å‹ï¼ˆè§„é¿â€œä¸æ”¯æŒæ–‡ä»¶ç±»å‹â€æŠ¥é”™ï¼‰
          if ! file cfst_temp.tar.gz | grep -q "gzip compressed"; then
            echo "âŒ é”™è¯¯ï¼šä¸‹è½½çš„æ–‡ä»¶ä¸æ˜¯æœ‰æ•ˆçš„ gzip å‹ç¼©åŒ…ï¼"
            exit 1
          fi

          # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨ï¼ˆæ ¹ç›®å½•ä¸‹çš„ cfst_linux_amd64ï¼‰
          TARGET_DIR="./cfst_linux_amd64"
          echo "ğŸ“‚ æ£€æŸ¥å¹¶åˆ›å»ºç›®æ ‡ç›®å½• $TARGET_DIR..."
          mkdir -p "$TARGET_DIR"
          
          # è§£å‹å‹ç¼©åŒ…åˆ°ä¸´æ—¶ç›®å½•ï¼Œå¤„ç†å¯èƒ½çš„å­ç›®å½•ç»“æ„
          echo "ğŸ“¦ è§£å‹æ–‡ä»¶åˆ°ç›®æ ‡ç›®å½•..."
          mkdir -p cfst_unpack_temp  # ä¸´æ—¶è§£å‹ç›®å½•
          tar -zxvf cfst_temp.tar.gz -C cfst_unpack_temp
          
          # å°†è§£å‹åçš„æ‰€æœ‰æ–‡ä»¶ç§»åŠ¨åˆ°ç›®æ ‡ç›®å½•ï¼ˆå…¼å®¹å‹ç¼©åŒ…å†…çš„å­ç›®å½•ç»“æ„ï¼‰
          # è‹¥å‹ç¼©åŒ…å†…æœ‰å­ç›®å½•ï¼Œé€’å½’ç§»åŠ¨æ‰€æœ‰æ–‡ä»¶åˆ°ç›®æ ‡ç›®å½•
          find cfst_unpack_temp -mindepth 1 -exec mv {} "$TARGET_DIR/" \;
          
          # è®¾ç½®ç›®æ ‡ç›®å½•å†…äºŒè¿›åˆ¶æ–‡ä»¶çš„æ‰§è¡Œæƒé™ï¼ˆå…³é”®æ–‡ä»¶ï¼šcfst æˆ– cfst_linux_amd64ï¼‰
          chmod +x "$TARGET_DIR"/cfst* 2>/dev/null  # å…¼å®¹ä¸åŒç‰ˆæœ¬çš„äºŒè¿›åˆ¶æ–‡ä»¶å
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -rf cfst_temp.tar.gz cfst_unpack_temp
          
          # åœ¨ç›®æ ‡ç›®å½•è®°å½•å½“å‰ç‰ˆæœ¬ï¼ˆç”¨äºä¸‹æ¬¡å¯¹æ¯”ï¼‰
          echo "${{ steps.get_latest.outputs.latest_version }}" > "$TARGET_DIR/VERSION"
          echo "âœ… å·²å°†æ–‡ä»¶éƒ¨ç½²åˆ° $TARGET_DIRï¼Œç‰ˆæœ¬æ›´æ–°ä¸º ${{ steps.get_latest.outputs.latest_version }}"

      # æ­¥éª¤5ï¼šæäº¤æ›´æ–°åˆ°ä»“åº“
      - name: Commit and push changes
        if: steps.check_update.outputs.update_needed == 'true'
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          git add ./cfst_linux_amd64  # æ·»åŠ ç›®æ ‡ç›®å½•æ‰€æœ‰æ–‡ä»¶
          git commit -m "Update CloudflareSpeedTest to ${{ steps.get_latest.outputs.latest_version }}"
          git push origin main  # æ›¿æ¢ä¸ºä½ çš„ä»“åº“ä¸»åˆ†æ”¯ï¼ˆå¦‚ masterï¼‰
          echo "âœ… å·²æ¨é€æ›´æ–°åˆ°ä»“åº“"
